name: 'MSK Safety Checks'
description: 'Validate MSK cluster, topic, user and ACL'

inputs:
  cluster-name:
    description: 'MSK Cluster Name'
    required: true
  topic-name:
    description: 'Kafka Topic Name'
    required: true
  username:
    description: 'Username'
    required: true
  permission:
    description: 'Permission'
    required: true
  aws-region:
    description: 'AWS Region'
    required: true
  admin-secret-id:
    description: 'Admin Secret ID in Secrets Manager'
    required: true

outputs:
  bootstrap-broker:
    description: 'Bootstrap Broker URL'
    value: ${{ steps.validation.outputs.bootstrap-broker }}
  cluster-arn:
    description: 'Cluster ARN'
    value: ${{ steps.validation.outputs.cluster-arn }}

runs:
  using: 'composite'
  steps:
    - name: Run All Validations
      id: validation
      shell: bash
      run: |
        export PATH=$PATH:/opt/kafka/bin

        AWS_REGION="${{ inputs.aws-region }}"
        CLUSTER_NAME="${{ inputs.cluster-name }}"
        TOPIC_NAME="${{ inputs.topic-name }}"
        USERNAME="${{ inputs.username }}"
        PERMISSION="${{ inputs.permission }}"
        ADMIN_SECRET_ID="${{ inputs.admin-secret-id }}"

        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 1 - Finding cluster '$CLUSTER_NAME'..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        CLUSTER_ARN=$(aws kafka list-clusters \
          --region "$AWS_REGION" \
          --cluster-name-filter "$CLUSTER_NAME" \
          --query 'ClusterInfoList[0].ClusterArn' \
          --output text 2>&1)

        if [ $? -ne 0 ] || [ "$CLUSTER_ARN" == "None" ] || [ -z "$CLUSTER_ARN" ]; then
          echo "‚ùå Cluster '$CLUSTER_NAME' NOT found!"
          exit 1
        fi

        echo "‚úÖ Cluster found! ARN: $CLUSTER_ARN"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 2 - Checking cluster state..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        CLUSTER_STATE=$(aws kafka describe-cluster \
          --cluster-arn "$CLUSTER_ARN" \
          --region "$AWS_REGION" \
          --query 'ClusterInfo.State' \
          --output text)

        if [ "$CLUSTER_STATE" != "ACTIVE" ]; then
          echo "‚ùå Cluster is NOT ACTIVE! State: $CLUSTER_STATE"
          exit 1
        fi

        echo "‚úÖ Cluster is ACTIVE!"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 3 - Fetching broker..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        BOOTSTRAP_BROKER=$(aws kafka get-bootstrap-brokers \
          --cluster-arn "$CLUSTER_ARN" \
          --region "$AWS_REGION" \
          --query 'BootstrapBrokerStringSaslScram' \
          --output text 2>&1)

        if [ $? -ne 0 ] || [ -z "$BOOTSTRAP_BROKER" ] || [ "$BOOTSTRAP_BROKER" == "None" ]; then
          echo "‚ùå Failed to get broker!"
          exit 1
        fi

        echo "‚úÖ Broker: $BOOTSTRAP_BROKER"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 4 - Creating client.properties..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        ADMIN_USER="admin"

        echo "security.protocol=SASL_SSL" > ~/client.properties
        echo "sasl.mechanism=SCRAM-SHA-512" >> ~/client.properties
        echo "sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=\"$ADMIN_USER\" password=\"$ADMIN_SECRET_ID\";" >> ~/client.properties

        echo "‚úÖ client.properties created!"
        cat ~/client.properties

        echo "‚úÖ client.properties created!"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 5 - Connecting to broker..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        TOPICS=$(kafka-topics.sh \
          --bootstrap-server "$BOOTSTRAP_BROKER" \
          --command-config ~/client.properties \
          --list 2>&1)

        if [ $? -ne 0 ]; then
          echo "‚ùå Failed to connect to broker!"
          echo "   Error: $TOPICS"
          exit 1
        fi

        echo "‚úÖ Connected! Total topics: $(echo "$TOPICS" | wc -l)"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 6 - Checking topic '$TOPIC_NAME'..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        TOPIC_EXISTS=$(echo "$TOPICS" | grep -w "$TOPIC_NAME" || true)

        if [ -z "$TOPIC_EXISTS" ]; then
          echo "‚ùå Topic '$TOPIC_NAME' NOT found!"
          echo "üëâ Please contact Admin to create topic"
          exit 1
        fi

        echo "‚úÖ Topic '$TOPIC_NAME' found!"

            echo "‚úÖ client.properties created!"
        cat ~/client.properties

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üîç Validation 4.1 - Setting admin permissions..."
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

        # Give admin CLUSTER ALL permission
        kafka-acls.sh \
          --bootstrap-server "$BOOTSTRAP_BROKER" \
          --command-config ~/client.properties \
          --add \
          --allow-principal "User:admin" \
          --operation ALL \
          --cluster 2>&1

        if [ $? -ne 0 ]; then
          echo "‚ö†Ô∏è Could not set cluster permission - may already exist"
        else
          echo "‚úÖ Admin CLUSTER ALL permission set!"
        fi